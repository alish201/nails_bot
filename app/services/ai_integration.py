"""
–°–µ—Ä–≤–∏—Å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ò–ò –∞–Ω–∞–ª–∏–∑–∞ –º–∞–Ω–∏–∫—é—Ä–∞

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–≥–æ—Ç–æ–≤–∫–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤–∞—à–∏—Ö –ò–ò-–º–æ–¥–µ–ª–µ–π.
–ó–∞–º–µ–Ω–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å "–í–ê–®_–ö–û–î_–ó–î–ï–°–¨" –Ω–∞ —Å–≤–æ—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é.
"""

import asyncio
from datetime import datetime
from typing import List, Dict, Any, Optional
from loguru import logger
import json


# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è –≤–∞—à–µ–≥–æ –ò–ò API (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏)
# import your_ai_client
# import openai
# import anthropic


class AIAnalysisService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ò–ò –∞–Ω–∞–ª–∏–∑–æ–º –º–∞–Ω–∏–∫—é—Ä–∞"""

    def __init__(self):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞—à–∏—Ö –ò–ò –∫–ª–∏–µ–Ω—Ç–æ–≤
        # self.ai_client = your_ai_client.Client(api_key="your_key")
        pass

    async def analyze_first_hand(
            self,
            photos: List[str],
            survey_data: str,
            analysis_id: int
    ) -> Dict[str, Any]:
        """
        –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–≤–æ–π —Ä—É–∫–∏

        Args:
            photos: –°–ø–∏—Å–æ–∫ file_id —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–µ—Ä–≤–æ–π —Ä—É–∫–∏
            survey_data: –û—Ç–≤–µ—Ç –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞ –æ–ø—Ä–æ—Å
            analysis_id: ID –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

        Returns:
            Dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞ –ø–µ—Ä–≤–æ–π —Ä—É–∫–∏
        """

        logger.info(f"Starting first hand analysis for analysis_id: {analysis_id}")

        try:
            # === –ó–î–ï–°–¨ –í–°–¢–ê–í–¨–¢–ï –í–ê–® –ü–†–û–ú–ü–¢ –î–õ–Ø –ü–ï–†–í–û–ô –†–£–ö–ò ===
            prompt_first_hand = """
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≥—Ç–µ–π –∏ –∫–æ–∂–∏ –Ω–∞ –ø–µ—Ä–≤–æ–π —Ä—É–∫–µ –∫–ª–∏–µ–Ω—Ç–∞.

            –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞:
            - –§–æ—Ä–º—É –Ω–æ–≥—Ç–µ–π –∏ –∏—Ö –¥–ª–∏–Ω—É
            - –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫—É—Ç–∏–∫—É–ª—ã
            - –¶–≤–µ—Ç –∏ —Ç–µ–∫—Å—Ç—É—Ä—É –Ω–æ–≥—Ç–µ–≤–æ–π –ø–ª–∞—Å—Ç–∏–Ω—ã
            - –ù–∞–ª–∏—á–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º
            - –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–∂–∏ —Ä—É–∫

            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –º–∞—Å—Ç–µ—Ä–∞: {survey_data}

            –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Ö–æ–¥—É.
            """

            # === –ó–î–ï–°–¨ –ü–û–î–ö–õ–Æ–ß–ò–¢–ï –í–ê–®–ï API ===
            # –ü—Ä–∏–º–µ—Ä —Å OpenAI (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–µ API)
            """
            response = await self.ai_client.chat.completions.create(
                model="gpt-4-vision-preview",
                messages=[
                    {
                        "role": "user", 
                        "content": [
                            {"type": "text", "text": prompt_first_hand.format(survey_data=survey_data)},
                            *[{"type": "image_url", "image_url": {"url": f"telegram_photo://{photo}"}} for photo in photos]
                        ]
                    }
                ],
                max_tokens=1000
            )

            analysis_result = response.choices[0].message.content
            """

            # === –í–†–ï–ú–ï–ù–ù–ê–Ø –ó–ê–ì–õ–£–®–ö–ê (—É–¥–∞–ª–∏—Ç–µ –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏) ===
            await asyncio.sleep(2)  # –ò–º–∏—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            analysis_result = f"""
            –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–≤–æ–π —Ä—É–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω.

            –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: {len(photos)}

            –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:
            - –§–æ—Ä–º–∞ –Ω–æ–≥—Ç–µ–π: –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è
            - –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫—É—Ç–∏–∫—É–ª—ã: —Ç—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
            - –¶–≤–µ—Ç –Ω–æ–≥—Ç–µ–≤–æ–π –ø–ª–∞—Å—Ç–∏–Ω—ã: –∑–¥–æ—Ä–æ–≤—ã–π —Ä–æ–∑–æ–≤—ã–π
            - –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è: –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞—É—Å–µ–Ω—Ü—ã

            –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
            - –†–µ–≥—É–ª—è—Ä–Ω–æ–µ —É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ –∫—É—Ç–∏–∫—É–ª—ã
            - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞—â–∏—Ç–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è
            - –ö–æ—Ä—Ä–µ–∫—Ü–∏—è —Ñ–æ—Ä–º—ã

            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–∞—Å—Ç–µ—Ä–∞ —É—á—Ç–µ–Ω: {survey_data[:100]}...
            """

            result = {
                "status": "completed",
                "hand": "first",
                "photos_analyzed": len(photos),
                "analysis_text": analysis_result,
                "recommendations": [
                    "–†–µ–≥—É–ª—è—Ä–Ω–æ–µ —É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ –∫—É—Ç–∏–∫—É–ª—ã",
                    "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞—â–∏—Ç–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è",
                    "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è —Ñ–æ—Ä–º—ã –Ω–æ–≥—Ç–µ–π"
                ],
                "quality_score": 8.5,  # –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (1-10)
                "problem_areas": ["–∫—É—Ç–∏–∫—É–ª–∞", "—Ñ–æ—Ä–º–∞ –Ω–æ–≥—Ç–µ–π"],
                "timestamp": datetime.now().isoformat(),
                "processing_time_seconds": 2
            }

            logger.info(f"First hand analysis completed for analysis_id: {analysis_id}")
            return result

        except Exception as e:
            logger.error(f"Error in first hand analysis: {e}")
            return {
                "status": "error",
                "hand": "first",
                "error": str(e),
                "timestamp": datetime.now().isoformat()
            }

    async def analyze_second_hand(
            self,
            photos: List[str],
            survey_data: str,
            analysis_id: int
    ) -> Dict[str, Any]:
        """
        –ê–Ω–∞–ª–∏–∑ –≤—Ç–æ—Ä–æ–π —Ä—É–∫–∏

        Args:
            photos: –°–ø–∏—Å–æ–∫ file_id —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤—Ç–æ—Ä–æ–π —Ä—É–∫–∏
            survey_data: –û—Ç–≤–µ—Ç –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞ –æ–ø—Ä–æ—Å
            analysis_id: ID –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

        Returns:
            Dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞ –≤—Ç–æ—Ä–æ–π —Ä—É–∫–∏
        """

        logger.info(f"Starting second hand analysis for analysis_id: {analysis_id}")

        try:
            # === –ó–î–ï–°–¨ –í–°–¢–ê–í–¨–¢–ï –í–ê–® –ü–†–û–ú–ü–¢ –î–õ–Ø –í–¢–û–†–û–ô –†–£–ö–ò ===
            prompt_second_hand = """
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≥—Ç–µ–π –∏ –∫–æ–∂–∏ –Ω–∞ –≤—Ç–æ—Ä–æ–π —Ä—É–∫–µ –∫–ª–∏–µ–Ω—Ç–∞.

            –°—Ä–∞–≤–Ω–∏ —Å –∞–Ω–∞–ª–∏–∑–æ–º –ø–µ—Ä–≤–æ–π —Ä—É–∫–∏ –∏ –æ—Ç–º–µ—Ç—å:
            - –°–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            - –†–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É —Ä—É–∫–∞–º–∏
            - –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
            - –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–Ω–æ –≤—Ç–æ—Ä–æ–π —Ä—É–∫–∏

            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –º–∞—Å—Ç–µ—Ä–∞: {survey_data}

            –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
            """

            # === –ó–î–ï–°–¨ –ü–û–î–ö–õ–Æ–ß–ò–¢–ï –í–ê–®–ï API ===
            # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–µ—Ä–≤–æ–π —Ä—É–∫–µ

            # === –í–†–ï–ú–ï–ù–ù–ê–Ø –ó–ê–ì–õ–£–®–ö–ê (—É–¥–∞–ª–∏—Ç–µ –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏) ===
            await asyncio.sleep(2)  # –ò–º–∏—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            analysis_result = f"""
            –ê–Ω–∞–ª–∏–∑ –≤—Ç–æ—Ä–æ–π —Ä—É–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω.

            –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π: {len(photos)}

            –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:
            - –°–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ—Å—Ç—å: —Ö–æ—Ä–æ—à–∞—è
            - –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–µ—Ä–≤–æ–π —Ä—É–∫–µ
            - –ö—É—Ç–∏–∫—É–ª–∞ –Ω–∞ –≤—Ç–æ—Ä–æ–π —Ä—É–∫–µ –≤ –ª—É—á—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
            - –§–æ—Ä–º–∞ –Ω–æ–≥—Ç–µ–π –±–æ–ª–µ–µ —Ä–æ–≤–Ω–∞—è

            –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤—Ç–æ—Ä–æ–π —Ä—É–∫–∏:
            - –ú–µ–Ω–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–µ –∑–∞—É—Å–µ–Ω—Ü—ã
            - –ë–æ–ª–µ–µ –∑–¥–æ—Ä–æ–≤—ã–π —Ü–≤–µ—Ç –Ω–æ–≥—Ç–µ–≤–æ–π –ø–ª–∞—Å—Ç–∏–Ω—ã
            - –õ—É—á—à–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–∂–∏

            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–∞—Å—Ç–µ—Ä–∞: {survey_data[:100]}...
            """

            result = {
                "status": "completed",
                "hand": "second",
                "photos_analyzed": len(photos),
                "analysis_text": analysis_result,
                "recommendations": [
                    "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
                    "–õ–µ–≥–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ñ–æ—Ä–º—ã",
                    "–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ"
                ],
                "quality_score": 9.0,  # –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (1-10)
                "problem_areas": ["–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–µ—Ä–æ–≤–Ω–æ—Å—Ç–∏"],
                "symmetry_score": 8.0,  # –°–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ—Å—Ç—å —Å –ø–µ—Ä–≤–æ–π —Ä—É–∫–æ–π
                "comparison_notes": "–í—Ç–æ—Ä–∞—è —Ä—É–∫–∞ –≤ –ª—É—á—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏",
                "timestamp": datetime.now().isoformat(),
                "processing_time_seconds": 2
            }

            logger.info(f"Second hand analysis completed for analysis_id: {analysis_id}")
            return result

        except Exception as e:
            logger.error(f"Error in second hand analysis: {e}")
            return {
                "status": "error",
                "hand": "second",
                "error": str(e),
                "timestamp": datetime.now().isoformat()
            }

    async def generate_growth_diary(
            self,
            first_analysis: Dict[str, Any],
            second_analysis: Dict[str, Any],
            survey_data: str,
            analysis_id: int
    ) -> Dict[str, Any]:
        """
        –°–æ–∑–¥–∞–Ω–∏–µ –¥–Ω–µ–≤–Ω–∏–∫–∞ —Ä–æ—Å—Ç–∞ –Ω–æ–≥—Ç–µ–π

        Args:
            first_analysis: –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø–µ—Ä–≤–æ–π —Ä—É–∫–∏
            second_analysis: –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤—Ç–æ—Ä–æ–π —Ä—É–∫–∏
            survey_data: –û—Ç–≤–µ—Ç –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞ –æ–ø—Ä–æ—Å
            analysis_id: ID –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

        Returns:
            Dict —Å –¥–Ω–µ–≤–Ω–∏–∫–æ–º —Ä–æ—Å—Ç–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
        """

        logger.info(f"Starting growth diary generation for analysis_id: {analysis_id}")

        try:
            # === –ó–î–ï–°–¨ –í–°–¢–ê–í–¨–¢–ï –í–ê–® –ü–†–û–ú–ü–¢ –î–õ–Ø –î–ù–ï–í–ù–ò–ö–ê –†–û–°–¢–ê ===
            prompt_growth_diary = """
            –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –æ–±–µ–∏—Ö —Ä—É–∫ —Å–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ —Ä–æ—Å—Ç–∞ –Ω–æ–≥—Ç–µ–π.

            –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ:
            - –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–≤–æ–π —Ä—É–∫–∏: {first_hand_summary}
            - –ê–Ω–∞–ª–∏–∑ –≤—Ç–æ—Ä–æ–π —Ä—É–∫–∏: {second_hand_summary}
            - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–∞—Å—Ç–µ—Ä–∞: {survey_data}

            –°–æ–∑–¥–∞–π:
            1. –ü–ª–∞–Ω —É—Ö–æ–¥–∞ –Ω–∞ 4 –Ω–µ–¥–µ–ª–∏
            2. –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏ –∏ –∑–∞–¥–∞—á–∏
            3. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
            4. –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            5. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö

            –§–æ—Ä–º–∞—Ç: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –≤ –≤–∏–¥–µ –¥–Ω–µ–≤–Ω–∏–∫–∞.
            """

            # === –ó–î–ï–°–¨ –ü–û–î–ö–õ–Æ–ß–ò–¢–ï –í–ê–®–ï API ===
            # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ –æ–±–µ–∏—Ö —Ä—É–∫

            # === –í–†–ï–ú–ï–ù–ù–ê–Ø –ó–ê–ì–õ–£–®–ö–ê (—É–¥–∞–ª–∏—Ç–µ –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏) ===
            await asyncio.sleep(3)  # –ò–º–∏—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

            first_score = first_analysis.get('quality_score', 0)
            second_score = second_analysis.get('quality_score', 0)
            avg_score = (first_score + second_score) / 2

            diary_content = f"""
            üóìÔ∏è –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô –î–ù–ï–í–ù–ò–ö –†–û–°–¢–ê –ù–û–ì–¢–ï–ô

            üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: {avg_score}/10
            üìù –ó–∞–º–µ—Ç–∫–∏ –º–∞—Å—Ç–µ—Ä–∞: {survey_data[:200]}...

            üìÖ –ü–õ–ê–ù –ù–ê 4 –ù–ï–î–ï–õ–ò:

            –ù–ï–î–ï–õ–Ø 1 - –ë–ê–ó–û–í–´–ô –£–•–û–î:
            ‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ –∫—É—Ç–∏–∫—É–ª—ã
            ‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è
            ‚Ä¢ –ò–∑–±–µ–≥–∞—Ç—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤

            –ù–ï–î–ï–õ–Ø 2 - –£–ö–†–ï–ü–õ–ï–ù–ò–ï:
            ‚Ä¢ –î–æ–±–∞–≤–∏—Ç—å —É–∫—Ä–µ–ø–ª—è—é—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
            ‚Ä¢ –ú–∞—Å—Å–∞–∂ —Ä—É–∫ —Å –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–º –º–∞—Å–ª–æ–º
            ‚Ä¢ –ö–æ—Ä—Ä–µ–∫—Ü–∏—è —Ñ–æ—Ä–º—ã (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)

            –ù–ï–î–ï–õ–Ø 3 - –ò–ù–¢–ï–ù–°–ò–í–ù–´–ô –£–•–û–î:
            ‚Ä¢ –ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –º–∞—Å–∫–∏ –¥–ª—è –Ω–æ–≥—Ç–µ–π
            ‚Ä¢ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫—É—Ç–∏–∫—É–ª—ã
            ‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–æ—Å—Ç–∞ –∏ —Ñ–æ—Ä–º—ã

            –ù–ï–î–ï–õ–Ø 4 - –ü–û–î–î–ï–†–ñ–ê–ù–ò–ï:
            ‚Ä¢ –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            ‚Ä¢ –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
            ‚Ä¢ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç—Ç–∞–ø–∞

            üéØ –ö–û–ù–¢–†–û–õ–¨–ù–´–ï –¢–û–ß–ö–ò:
            ‚Ä¢ –î–µ–Ω—å 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–ª–∞–∂–Ω–µ–Ω–Ω–æ—Å—Ç–∏
            ‚Ä¢ –î–µ–Ω—å 14: –û—Ü–µ–Ω–∫–∞ —É–∫—Ä–µ–ø–ª–µ–Ω–∏—è
            ‚Ä¢ –î–µ–Ω—å 21: –ê–Ω–∞–ª–∏–∑ —Ä–æ—Å—Ç–∞
            ‚Ä¢ –î–µ–Ω—å 28: –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞

            ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø:
            ‚Ä¢ –ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏—è - –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
            ‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –º–∞—Å—Ç–µ—Ä—É –ø—Ä–∏ —É—Ö—É–¥—à–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            ‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
            """

            result = {
                "status": "generated",
                "diary_content": diary_content,
                "plan_duration_weeks": 4,
                "current_score": avg_score,
                "target_score": min(10.0, avg_score + 1.5),
                "weekly_goals": [
                    "–ë–∞–∑–æ–≤—ã–π —É—Ö–æ–¥ –∏ —É–≤–ª–∞–∂–Ω–µ–Ω–∏–µ",
                    "–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ",
                    "–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–π —É—Ö–æ–¥",
                    "–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
                ],
                "recommended_products": [
                    "–ú–∞—Å–ª–æ –¥–ª—è –∫—É—Ç–∏–∫—É–ª—ã",
                    "–ë–∞–∑–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ",
                    "–£–∫—Ä–µ–ø–ª—è—é—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ",
                    "–ü–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–π –∫—Ä–µ–º –¥–ª—è —Ä—É–∫"
                ],
                "checkpoints": [7, 14, 21, 28],
                "estimated_improvement": "15-20%",
                "timestamp": datetime.now().isoformat(),
                "processing_time_seconds": 3
            }

            logger.info(f"Growth diary generated for analysis_id: {analysis_id}")
            return result

        except Exception as e:
            logger.error(f"Error in growth diary generation: {e}")
            return {
                "status": "error",
                "error": str(e),
                "timestamp": datetime.now().isoformat()
            }

    async def validate_photos(self, photos: List[str]) -> Dict[str, Any]:
        """
        –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º

        Args:
            photos: –°–ø–∏—Å–æ–∫ file_id —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π

        Returns:
            Dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        """
        try:
            # === –ó–î–ï–°–¨ –î–û–ë–ê–í–¨–¢–ï –í–ê–õ–ò–î–ê–¶–ò–Æ –§–û–¢–û ===
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞, –æ—Å–≤–µ—â–µ–Ω–∏—è, —á–µ—Ç–∫–æ—Å—Ç–∏ –∏ —Ç.–¥.

            # –ó–∞–≥–ª—É—à–∫–∞
            return {
                "status": "valid",
                "photos_count": len(photos),
                "quality_issues": [],
                "recommendations": []
            }

        except Exception as e:
            return {
                "status": "error",
                "error": str(e)
            }


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
ai_service = AIAnalysisService()


# === –§–£–ù–ö–¶–ò–ò-–û–ë–ï–†–¢–ö–ò –î–õ–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –í HANDLERS ===

async def analyze_first_hand_ai(photos: List[str], survey_data: str, analysis_id: int = 0) -> dict:
    """–û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–µ—Ä–≤–æ–π —Ä—É–∫–∏"""
    return await ai_service.analyze_first_hand(photos, survey_data, analysis_id)


async def analyze_second_hand_ai(photos: List[str], survey_data: str, analysis_id: int = 0) -> dict:
    """–û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤—Ç–æ—Ä–æ–π —Ä—É–∫–∏"""
    return await ai_service.analyze_second_hand(photos, survey_data, analysis_id)


async def generate_growth_diary_ai(first_analysis: dict, second_analysis: dict, survey_data: str,
                                   analysis_id: int = 0) -> dict:
    """–û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞ —Ä–æ—Å—Ç–∞"""
    return await ai_service.generate_growth_diary(first_analysis, second_analysis, survey_data, analysis_id)


# === –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ò–ù–¢–ï–ì–†–ê–¶–ò–ò ===

"""
üîß –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –° –í–ê–®–ò–ú –ò–ò:

1. –ó–ê–ú–ï–ù–ò–¢–ï –ü–†–û–ú–ü–¢–´:
   - –ù–∞–π–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ "–ó–î–ï–°–¨ –í–°–¢–ê–í–¨–¢–ï –í–ê–® –ü–†–û–ú–ü–¢"
   - –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ –∞–Ω–∞–ª–∏–∑–∞

2. –ü–û–î–ö–õ–Æ–ß–ò–¢–ï API:
   - –ù–∞–π–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ "–ó–î–ï–°–¨ –ü–û–î–ö–õ–Æ–ß–ò–¢–ï –í–ê–®–ï API"
   - –ó–∞–º–µ–Ω–∏—Ç–µ –∑–∞–≥–ª—É—à–∫–∏ –Ω–∞ –≤—ã–∑–æ–≤—ã –≤–∞—à–µ–≥–æ –ò–ò API
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

3. –£–î–ê–õ–ò–¢–ï –ó–ê–ì–õ–£–®–ö–ò:
   - –ù–∞–π–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ "–í–†–ï–ú–ï–ù–ù–ê–Ø –ó–ê–ì–õ–£–®–ö–ê"
   - –£–¥–∞–ª–∏—Ç–µ –∫–æ–¥ –º–µ–∂–¥—É —ç—Ç–∏–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
   - –û—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–ª—å–∫–æ –≤–∞—à—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é

4. –ù–ê–°–¢–†–û–ô–¢–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï:
   - –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤/–∑–∞–ø—Ä–æ—Å–æ–≤

5. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ
   - –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

–ü–†–ò–ú–ï–† –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –° OPENAI:
```python
async def analyze_first_hand(self, photos, survey_data, analysis_id):
    response = await openai.ChatCompletion.acreate(
        model="gpt-4-vision-preview",
        messages=[{
            "role": "user",
            "content": [
                {"type": "text", "text": YOUR_PROMPT},
                *[{"type": "image_url", "image_url": {"url": photo_url}} for photo_url in photos]
            ]
        }],
        max_tokens=1000
    )
    return {"analysis_text": response.choices[0].message.content, ...}
```
"""